module.exports=[89289,a=>{"use strict";var b=a.i(87924),c=a.i(72131),d=a.i(69240),e=a.i(3650),f=a.i(21929),g=a.i(68979);function h(){let[a,h]=(0,c.useState)([]),[i,j]=(0,c.useState)([]),[k,l]=(0,c.useState)(null),[m,n]=(0,c.useState)(!0),[o,p]=(0,c.useState)(!1),[q,r]=(0,c.useState)(null),[s,t]=(0,c.useState)({name:"",email:"",relationship:"",role:"member"}),[u,v]=(0,c.useState)([]),[w,x]=(0,c.useState)(null),[y,z]=(0,c.useState)(null),[A,B]=(0,c.useState)(!1),[C,D]=(0,c.useState)(!1),[E,F]=(0,c.useState)(null),[G,H]=(0,c.useState)({}),I=(0,d.createClient)(),J=["Parent of","Child of","Spouse of","Sibling of","Grandparent of","Grandchild of"],K=[{value:"admin",label:"Admin",icon:f.faShieldAlt},{value:"editor",label:"Editor",icon:f.faUserEdit},{value:"member",label:"Member",icon:f.faUser}];(0,c.useEffect)(()=>{L()},[]);let L=async()=>{try{let a=await (0,g.getFamilyId)(I);if(a){l(a);let b=await (0,g.isEditorOrAdmin)(I,a);D(b),await O(a),await P(a)}}catch(a){console.error("Error loading data:",a)}finally{n(!1)}},M=async(b,c=a)=>{let{data:d}=await I.from("family_users").select("user_id").eq("family_id",b);if(!d)return;let e=new Set(d.map(a=>a.user_id)),f={};for(let a of c)if(a.email)try{let b=await fetch("/api/get-user-by-email",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:a.email})}),c=await b.json();c.userId&&e.has(c.userId)?f[a.id]=!0:f[a.id]=!1}catch{f[a.id]=!1}H(f)},N=async a=>{if(k&&a.email){F(a.id);try{let b=await fetch("/api/invitations",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:a.email,role:s.role||"member",familyId:k})}),c=await b.json();if(!b.ok)throw Error(c.message||c.error||"Failed to create invitation");alert(`Invitation sent to ${a.email}! Share this link: ${window.location.origin}/auth/signup?token=${c.data.token}`),await M(k)}catch(a){console.error("Error inviting member:",a),alert(a.message||"Failed to send invitation")}finally{F(null)}}},O=async a=>{let{data:b,error:c}=await I.from("family_members").select("*").eq("family_id",a).order("created_at",{ascending:!1});c?console.error("Error loading family members:",c):h(b||[])},P=async a=>{let{data:b,error:c}=await I.from("family_connections").select("*").eq("family_id",a);c?console.error("Error loading family connections:",c):j(b||[])},Q=async(a,b)=>{try{B(!0);let c=a.name.split(".").pop(),d=`${k}/${b}-${Date.now()}.${c}`,{data:e,error:f}=await I.storage.from("family-member-photos").upload(d,a,{cacheControl:"3600",upsert:!1});if(f)throw f;let{data:g}=I.storage.from("family-member-photos").getPublicUrl(d);return g.publicUrl}catch(a){return console.error("Error uploading image:",a),alert("Failed to upload image. Please try again."),null}finally{B(!1)}},R=async a=>{try{let b=a.split("/family-member-photos/");if(b.length>1){let a=b[1];await I.storage.from("family-member-photos").remove([a])}}catch(a){console.error("Error deleting old image:",a)}},S=async a=>{if(a.preventDefault(),k)try{let a,b=null;if(w&&q?.image_url&&await R(q.image_url),q){a=q.id,w&&(b=await Q(w,a));let c={name:s.name,email:s.email||null,relationship:s.relationship};b&&(c.image_url=b);let{error:d}=await I.from("family_members").update(c).eq("id",q.id);if(d)throw d;if(s.email){let a=await fetch("/api/get-user-by-email",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:s.email})}),b=await a.json();if(b.userId){let{error:a}=await I.from("family_users").update({role:s.role}).eq("family_id",k).eq("user_id",b.userId);a&&"PGRST116"!==a.code&&console.error("Error updating family_users:",a)}}await I.from("family_connections").delete().eq("member_id",a)}else{let{data:c,error:d}=await I.from("family_members").insert({family_id:k,name:s.name,email:s.email||null,relationship:s.relationship}).select().single();if(d)throw d;if(a=c.id,w&&(b=await Q(w,a))&&await I.from("family_members").update({image_url:b}).eq("id",a),s.email)try{let a=await fetch("/api/add-family-user",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:s.email,role:s.role,familyId:k})}),b=await a.json();a.ok||"User already exists"===b.error||console.warn("Could not add user to family_users:",b.message||b.error)}catch(a){console.warn("Error adding user to family_users:",a)}}if(u.length>0){let b=u.map(b=>({family_id:k,member_id:a,related_member_id:b.relatedMemberId,relationship_type:b.relationshipType})),{error:c}=await I.from("family_connections").insert(b);if(c)throw c}await O(k),await P(k),t({name:"",email:"",relationship:"",role:"member"}),v([]),x(null),z(null),p(!1),r(null)}catch(a){console.error("Error saving family member:",a)}},T=async a=>{r(a);let b="member";if(a.email&&k)try{let c=await fetch("/api/get-user-by-email",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:a.email})}),d=await c.json();if(d.userId){let{data:a}=await I.from("family_users").select("role").eq("family_id",k).eq("user_id",d.userId).maybeSingle();a&&(b=a.role)}}catch(a){console.warn("Could not fetch user role:",a)}t({name:a.name,email:a.email||"",relationship:a.relationship,role:b}),a.image_url&&z(a.image_url),v(i.filter(b=>b.member_id===a.id).map(a=>({relatedMemberId:a.related_member_id,relationshipType:a.relationship_type}))),p(!0)},U=(a,b,c)=>{let d=[...u];d[a][b]=c,v(d)},V=a=>i.filter(b=>b.member_id===a),W=async a=>{if(confirm("Are you sure you want to remove this family member?"))try{let{error:b}=await I.from("family_members").delete().eq("id",a);if(b)throw b;k&&await O(k)}catch(a){console.error("Error deleting family member:",a)}};return m?(0,b.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,b.jsxs)("div",{className:"text-center",children:[(0,b.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"}),(0,b.jsx)("p",{className:"mt-4 text-gray-600",children:"Loading..."})]})}):(0,b.jsxs)("div",{className:"max-w-7xl mx-auto",children:[(0,b.jsxs)("div",{className:"flex items-center justify-between mb-8",children:[(0,b.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,b.jsx)("div",{className:"w-12 h-12 bg-purple-500 rounded-lg flex items-center justify-center",children:(0,b.jsx)(e.FontAwesomeIcon,{icon:f.faUsers,className:"text-white text-xl"})}),(0,b.jsxs)("div",{children:[(0,b.jsx)("h1",{className:"text-3xl font-bold text-gray-900",children:"Family Tree"}),(0,b.jsx)("p",{className:"text-gray-600",children:"Manage your family members"})]})]}),C&&(0,b.jsxs)("button",{onClick:()=>p(!o),className:"btn-primary",children:[(0,b.jsx)(e.FontAwesomeIcon,{icon:f.faPlus,className:"mr-2"}),"Add Member"]})]}),o&&C&&(0,b.jsxs)("div",{className:"card mb-6",children:[(0,b.jsx)("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:q?"Edit Family Member":"Add Family Member"}),(0,b.jsxs)("form",{onSubmit:S,className:"space-y-6",children:[(0,b.jsxs)("div",{className:"flex items-center gap-6",children:[(0,b.jsx)("div",{className:"relative",children:y?(0,b.jsxs)("div",{className:"relative w-32 h-32 rounded-full overflow-hidden border-4 border-indigo-100",children:[(0,b.jsx)("img",{src:y,alt:"Member preview",className:"w-full h-full object-cover"}),(0,b.jsx)("button",{type:"button",onClick:()=>{x(null),z(null)},className:"absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-700",children:(0,b.jsx)(e.FontAwesomeIcon,{icon:f.faTimes,className:"text-xs"})})]}):(0,b.jsx)("div",{className:"w-32 h-32 rounded-full bg-gradient-to-br from-indigo-400 to-purple-500 flex items-center justify-center",children:(0,b.jsx)(e.FontAwesomeIcon,{icon:f.faUser,className:"text-white text-4xl"})})}),(0,b.jsxs)("div",{className:"flex-1",children:[(0,b.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Member Photo (Optional)"}),(0,b.jsx)("input",{type:"file",accept:"image/*",onChange:a=>{let b=a.target.files?.[0];if(!b)return;if(!b.type.startsWith("image/"))return void alert("Please select an image file");if(b.size>5242880)return void alert("Image size should be less than 5MB");x(b);let c=new FileReader;c.onload=a=>{z(a.target?.result)},c.readAsDataURL(b)},className:"input-field"}),(0,b.jsx)("p",{className:"text-xs text-gray-500 mt-2",children:"Upload a photo (max 5MB). Supports JPG, PNG, GIF."})]})]}),(0,b.jsxs)("div",{className:"grid md:grid-cols-2 lg:grid-cols-4 gap-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Name"}),(0,b.jsxs)("div",{className:"relative",children:[(0,b.jsx)("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:(0,b.jsx)(e.FontAwesomeIcon,{icon:f.faUser,className:"text-gray-400"})}),(0,b.jsx)("input",{type:"text",value:s.name,onChange:a=>t({...s,name:a.target.value}),className:"input-field pl-10",placeholder:"Family member name",required:!0})]})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Email"}),(0,b.jsxs)("div",{className:"relative",children:[(0,b.jsx)("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:(0,b.jsx)(e.FontAwesomeIcon,{icon:f.faEnvelope,className:"text-gray-400"})}),(0,b.jsx)("input",{type:"email",value:s.email,onChange:a=>t({...s,email:a.target.value}),className:"input-field pl-10",placeholder:"member@example.com"})]}),(0,b.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:"Required to add as app user"})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Relationship"}),(0,b.jsxs)("select",{value:s.relationship,onChange:a=>t({...s,relationship:a.target.value}),className:"input-field",required:!0,children:[(0,b.jsx)("option",{value:"",children:"Select relationship"}),["Spouse","Parent","Child","Sibling","Grandparent","Grandchild","Aunt/Uncle","Cousin","Other"].map(a=>(0,b.jsx)("option",{value:a,children:a},a))]})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Role"}),(0,b.jsx)("select",{value:s.role,onChange:a=>t({...s,role:a.target.value}),className:"input-field",disabled:!s.email,children:K.map(a=>(0,b.jsx)("option",{value:a.value,children:a.label},a.value))}),(0,b.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:s.email?"App user permissions":"Enter email to set role"})]}),(0,b.jsxs)("div",{className:"md:col-span-4 flex space-x-3",children:[(0,b.jsx)("button",{type:"button",onClick:()=>{p(!1),r(null),t({name:"",email:"",relationship:"",role:"member"}),v([]),x(null),z(null)},className:"btn-secondary",children:"Cancel"}),(0,b.jsx)("button",{type:"submit",className:"btn-primary",disabled:A,children:A?"Uploading...":q?"Update Member":"Add Member"})]})]}),a.length>0&&(0,b.jsxs)("div",{className:"md:col-span-4 border-t border-gray-200 pt-6",children:[(0,b.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("h3",{className:"text-lg font-semibold text-gray-900",children:"Family Connections (Optional)"}),(0,b.jsx)("p",{className:"text-sm text-gray-600",children:"Define how this member is related to other family members"})]}),(0,b.jsxs)("button",{type:"button",onClick:()=>{v([...u,{relatedMemberId:"",relationshipType:""}])},className:"btn-secondary text-sm",children:[(0,b.jsx)(e.FontAwesomeIcon,{icon:f.faPlus,className:"mr-2"}),"Add Connection"]})]}),u.length>0&&(0,b.jsx)("div",{className:"space-y-3",children:u.map((c,d)=>(0,b.jsxs)("div",{className:"grid grid-cols-2 gap-3 items-end bg-gray-50 p-3 rounded-lg",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"This member is:"}),(0,b.jsxs)("select",{value:c.relationshipType,onChange:a=>U(d,"relationshipType",a.target.value),className:"input-field text-sm",required:!0,children:[(0,b.jsx)("option",{value:"",children:"Select relationship"}),J.map(a=>(0,b.jsx)("option",{value:a,children:a},a))]})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Related to:"}),(0,b.jsxs)("div",{className:"flex gap-2",children:[(0,b.jsxs)("select",{value:c.relatedMemberId,onChange:a=>U(d,"relatedMemberId",a.target.value),className:"input-field text-sm flex-1",required:!0,children:[(0,b.jsx)("option",{value:"",children:"Select member"}),a.filter(a=>!q||a.id!==q.id).map(a=>(0,b.jsx)("option",{value:a.id,children:a.name},a.id))]}),(0,b.jsx)("button",{type:"button",onClick:()=>{v(u.filter((a,b)=>b!==d))},className:"text-red-600 hover:text-red-700 px-3 py-2 rounded-lg hover:bg-red-50",children:(0,b.jsx)(e.FontAwesomeIcon,{icon:f.faTrash})})]})]})]},d))}),0===u.length&&(0,b.jsx)("p",{className:"text-sm text-gray-500 text-center py-4",children:'No connections added yet. Click "Add Connection" to define relationships.'})]})]})]}),0===a.length?(0,b.jsxs)("div",{className:"text-center py-12 card",children:[(0,b.jsx)(e.FontAwesomeIcon,{icon:f.faUsers,className:"text-6xl text-gray-300 mb-4"}),(0,b.jsx)("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"No Family Members Yet"}),(0,b.jsx)("p",{className:"text-gray-600 mb-6",children:"Start building your family tree"}),C&&(0,b.jsxs)("button",{onClick:()=>p(!0),className:"btn-primary",children:[(0,b.jsx)(e.FontAwesomeIcon,{icon:f.faPlus,className:"mr-2"}),"Add Your First Member"]})]}):(0,b.jsx)("div",{className:"grid md:grid-cols-2 lg:grid-cols-3 gap-6",children:a.map(c=>(0,b.jsx)("div",{className:"card hover:shadow-lg transition-shadow",children:(0,b.jsxs)("div",{className:"flex items-start justify-between",children:[(0,b.jsxs)("div",{className:"flex-1",children:[(0,b.jsx)("div",{className:"w-16 h-16 rounded-full overflow-hidden mb-3 border-2 border-indigo-200",children:c.image_url?(0,b.jsx)("img",{src:c.image_url,alt:c.name,className:"w-full h-full object-cover"}):(0,b.jsx)("div",{className:"w-full h-full bg-gradient-to-br from-indigo-400 to-purple-500 flex items-center justify-center",children:(0,b.jsx)(e.FontAwesomeIcon,{icon:f.faUser,className:"text-white text-2xl"})})}),(0,b.jsx)("h3",{className:"text-lg font-semibold text-gray-900",children:c.name}),(0,b.jsx)("p",{className:"text-sm text-gray-600 mt-1",children:c.relationship}),c.email&&(0,b.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:c.email}),V(c.id).length>0&&(0,b.jsxs)("div",{className:"mt-3 pt-3 border-t border-gray-200",children:[(0,b.jsx)("p",{className:"text-xs font-semibold text-gray-700 mb-1",children:"Connections:"}),(0,b.jsx)("div",{className:"space-y-1",children:V(c.id).map(c=>{let d;return(0,b.jsxs)("p",{className:"text-xs text-gray-600",children:["â€¢ ",c.relationship_type," ",(0,b.jsx)("span",{className:"font-medium",children:(d=c.related_member_id,a.find(a=>a.id===d)?.name||"Unknown")})]},c.id)})})]})]}),(0,b.jsxs)("div",{className:"flex flex-col gap-2",children:[c.email&&!G[c.id]&&C&&(0,b.jsx)("button",{onClick:()=>N(c),disabled:E===c.id,className:"text-green-600 hover:text-green-700 p-2 rounded-lg hover:bg-green-50 transition-colors disabled:opacity-50",title:"Invite as user",children:(0,b.jsx)(e.FontAwesomeIcon,{icon:f.faPaperPlane})}),C&&(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)("button",{onClick:()=>T(c),className:"text-indigo-600 hover:text-indigo-700 p-2 rounded-lg hover:bg-indigo-50 transition-colors",title:"Edit member",children:(0,b.jsx)(e.FontAwesomeIcon,{icon:f.faEdit})}),(0,b.jsx)("button",{onClick:()=>W(c.id),className:"text-red-600 hover:text-red-700 p-2 rounded-lg hover:bg-red-50 transition-colors",title:"Delete member",children:(0,b.jsx)(e.FontAwesomeIcon,{icon:f.faTrash})})]})]})]})},c.id))})]})}a.s(["default",()=>h,"dynamic",0,"force-dynamic"])}];

//# sourceMappingURL=app_dashboard_family_page_tsx_57939305._.js.map