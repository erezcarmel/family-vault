(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,75364,e=>{"use strict";var a=e.i(43476),t=e.i(71645),l=e.i(20755),i=e.i(49721),s=e.i(68757),r=e.i(98484);function n(){let[e,n]=(0,t.useState)([]),[o,m]=(0,t.useState)([]),[d,c]=(0,t.useState)(null),[x,h]=(0,t.useState)(!0),[u,f]=(0,t.useState)(!1),[p,b]=(0,t.useState)(null),[y,g]=(0,t.useState)({name:"",email:"",relationship:"",role:"member"}),[j,v]=(0,t.useState)([]),[N,w]=(0,t.useState)(null),[_,S]=(0,t.useState)(null),[C,I]=(0,t.useState)(!1),[A,F]=(0,t.useState)(!1),[T,k]=(0,t.useState)(null),[E,P]=(0,t.useState)({}),M=(0,l.createClient)(),U=["Parent of","Child of","Spouse of","Sibling of","Grandparent of","Grandchild of"],q=[{value:"admin",label:"Admin",icon:s.faShieldAlt},{value:"editor",label:"Editor",icon:s.faUserEdit},{value:"member",label:"Member",icon:s.faUser}];(0,t.useEffect)(()=>{O()},[]);let O=async()=>{try{let e=await (0,r.getFamilyId)(M);if(e){c(e);let a=await (0,r.isEditorOrAdmin)(M,e);F(a),await $(e),await J(e)}}catch(e){console.error("Error loading data:",e)}finally{h(!1)}},R=async(a,t=e)=>{let{data:l}=await M.from("family_users").select("user_id").eq("family_id",a);if(!l)return;let i=new Set(l.map(e=>e.user_id)),s={};for(let e of t)if(e.email)try{let a=await fetch("/api/get-user-by-email",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e.email})}),t=await a.json();t.userId&&i.has(t.userId)?s[e.id]=!0:s[e.id]=!1}catch{s[e.id]=!1}P(s)},G=async e=>{if(d&&e.email){k(e.id);try{let a=await fetch("/api/invitations",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e.email,role:y.role||"member",familyId:d})}),t=await a.json();if(!a.ok)throw Error(t.message||t.error||"Failed to create invitation");alert(`Invitation sent to ${e.email}! Share this link: ${window.location.origin}/auth/signup?token=${t.data.token}`),await R(d)}catch(e){console.error("Error inviting member:",e),alert(e.message||"Failed to send invitation")}finally{k(null)}}},$=async e=>{let{data:a,error:t}=await M.from("family_members").select("*").eq("family_id",e).order("created_at",{ascending:!1});t?console.error("Error loading family members:",t):n(a||[])},J=async e=>{let{data:a,error:t}=await M.from("family_connections").select("*").eq("family_id",e);t?console.error("Error loading family connections:",t):m(a||[])},D=async(e,a)=>{try{I(!0);let t=e.name.split(".").pop(),l=`${d}/${a}-${Date.now()}.${t}`,{data:i,error:s}=await M.storage.from("family-member-photos").upload(l,e,{cacheControl:"3600",upsert:!1});if(s)throw s;let{data:r}=M.storage.from("family-member-photos").getPublicUrl(l);return r.publicUrl}catch(e){return console.error("Error uploading image:",e),alert("Failed to upload image. Please try again."),null}finally{I(!1)}},B=async e=>{try{let a=e.split("/family-member-photos/");if(a.length>1){let e=a[1];await M.storage.from("family-member-photos").remove([e])}}catch(e){console.error("Error deleting old image:",e)}},z=async e=>{if(e.preventDefault(),d)try{let e,a=null;if(N&&p?.image_url&&await B(p.image_url),p){e=p.id,N&&(a=await D(N,e));let t={name:y.name,email:y.email||null,relationship:y.relationship};a&&(t.image_url=a);let{error:l}=await M.from("family_members").update(t).eq("id",p.id);if(l)throw l;if(y.email){let e=await fetch("/api/get-user-by-email",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:y.email})}),a=await e.json();if(a.userId){let{error:e}=await M.from("family_users").update({role:y.role}).eq("family_id",d).eq("user_id",a.userId);e&&"PGRST116"!==e.code&&console.error("Error updating family_users:",e)}}await M.from("family_connections").delete().eq("member_id",e)}else{let{data:t,error:l}=await M.from("family_members").insert({family_id:d,name:y.name,email:y.email||null,relationship:y.relationship}).select().single();if(l)throw l;if(e=t.id,N&&(a=await D(N,e))&&await M.from("family_members").update({image_url:a}).eq("id",e),y.email)try{let e=await fetch("/api/add-family-user",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:y.email,role:y.role,familyId:d})}),a=await e.json();e.ok||"User already exists"===a.error||console.warn("Could not add user to family_users:",a.message||a.error)}catch(e){console.warn("Error adding user to family_users:",e)}}if(j.length>0){let a=j.map(a=>({family_id:d,member_id:e,related_member_id:a.relatedMemberId,relationship_type:a.relationshipType})),{error:t}=await M.from("family_connections").insert(a);if(t)throw t}await $(d),await J(d),g({name:"",email:"",relationship:"",role:"member"}),v([]),w(null),S(null),f(!1),b(null)}catch(e){console.error("Error saving family member:",e)}},K=async e=>{b(e);let a="member";if(e.email&&d)try{let t=await fetch("/api/get-user-by-email",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e.email})}),l=await t.json();if(l.userId){let{data:e}=await M.from("family_users").select("role").eq("family_id",d).eq("user_id",l.userId).maybeSingle();e&&(a=e.role)}}catch(e){console.warn("Could not fetch user role:",e)}g({name:e.name,email:e.email||"",relationship:e.relationship,role:a}),e.image_url&&S(e.image_url),v(o.filter(a=>a.member_id===e.id).map(e=>({relatedMemberId:e.related_member_id,relationshipType:e.relationship_type}))),f(!0)},L=(e,a,t)=>{let l=[...j];l[e][a]=t,v(l)},Y=e=>o.filter(a=>a.member_id===e),W=async e=>{if(confirm("Are you sure you want to remove this family member?"))try{let{error:a}=await M.from("family_members").delete().eq("id",e);if(a)throw a;d&&await $(d)}catch(e){console.error("Error deleting family member:",e)}};return x?(0,a.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"}),(0,a.jsx)("p",{className:"mt-4 text-gray-600",children:"Loading..."})]})}):(0,a.jsxs)("div",{className:"max-w-7xl mx-auto",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-8",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,a.jsx)("div",{className:"w-12 h-12 bg-purple-500 rounded-lg flex items-center justify-center",children:(0,a.jsx)(i.FontAwesomeIcon,{icon:s.faUsers,className:"text-white text-xl"})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h1",{className:"text-3xl font-bold text-gray-900",children:"Family Tree"}),(0,a.jsx)("p",{className:"text-gray-600",children:"Manage your family members"})]})]}),A&&(0,a.jsxs)("button",{onClick:()=>f(!u),className:"btn-primary",children:[(0,a.jsx)(i.FontAwesomeIcon,{icon:s.faPlus,className:"mr-2"}),"Add Member"]})]}),u&&A&&(0,a.jsxs)("div",{className:"card mb-6",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:p?"Edit Family Member":"Add Family Member"}),(0,a.jsxs)("form",{onSubmit:z,className:"space-y-6",children:[(0,a.jsxs)("div",{className:"flex items-center gap-6",children:[(0,a.jsx)("div",{className:"relative",children:_?(0,a.jsxs)("div",{className:"relative w-32 h-32 rounded-full overflow-hidden border-4 border-indigo-100",children:[(0,a.jsx)("img",{src:_,alt:"Member preview",className:"w-full h-full object-cover"}),(0,a.jsx)("button",{type:"button",onClick:()=>{w(null),S(null)},className:"absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-700",children:(0,a.jsx)(i.FontAwesomeIcon,{icon:s.faTimes,className:"text-xs"})})]}):(0,a.jsx)("div",{className:"w-32 h-32 rounded-full bg-gradient-to-br from-indigo-400 to-purple-500 flex items-center justify-center",children:(0,a.jsx)(i.FontAwesomeIcon,{icon:s.faUser,className:"text-white text-4xl"})})}),(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Member Photo (Optional)"}),(0,a.jsx)("input",{type:"file",accept:"image/*",onChange:e=>{let a=e.target.files?.[0];if(!a)return;if(!a.type.startsWith("image/"))return void alert("Please select an image file");if(a.size>5242880)return void alert("Image size should be less than 5MB");w(a);let t=new FileReader;t.onload=e=>{S(e.target?.result)},t.readAsDataURL(a)},className:"input-field"}),(0,a.jsx)("p",{className:"text-xs text-gray-500 mt-2",children:"Upload a photo (max 5MB). Supports JPG, PNG, GIF."})]})]}),(0,a.jsxs)("div",{className:"grid md:grid-cols-2 lg:grid-cols-4 gap-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Name"}),(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:(0,a.jsx)(i.FontAwesomeIcon,{icon:s.faUser,className:"text-gray-400"})}),(0,a.jsx)("input",{type:"text",value:y.name,onChange:e=>g({...y,name:e.target.value}),className:"input-field pl-10",placeholder:"Family member name",required:!0})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Email"}),(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:(0,a.jsx)(i.FontAwesomeIcon,{icon:s.faEnvelope,className:"text-gray-400"})}),(0,a.jsx)("input",{type:"email",value:y.email,onChange:e=>g({...y,email:e.target.value}),className:"input-field pl-10",placeholder:"member@example.com"})]}),(0,a.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:"Required to add as app user"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Relationship"}),(0,a.jsxs)("select",{value:y.relationship,onChange:e=>g({...y,relationship:e.target.value}),className:"input-field",required:!0,children:[(0,a.jsx)("option",{value:"",children:"Select relationship"}),["Spouse","Parent","Child","Sibling","Grandparent","Grandchild","Aunt/Uncle","Cousin","Other"].map(e=>(0,a.jsx)("option",{value:e,children:e},e))]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Role"}),(0,a.jsx)("select",{value:y.role,onChange:e=>g({...y,role:e.target.value}),className:"input-field",disabled:!y.email,children:q.map(e=>(0,a.jsx)("option",{value:e.value,children:e.label},e.value))}),(0,a.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:y.email?"App user permissions":"Enter email to set role"})]}),(0,a.jsxs)("div",{className:"md:col-span-4 flex space-x-3",children:[(0,a.jsx)("button",{type:"button",onClick:()=>{f(!1),b(null),g({name:"",email:"",relationship:"",role:"member"}),v([]),w(null),S(null)},className:"btn-secondary",children:"Cancel"}),(0,a.jsx)("button",{type:"submit",className:"btn-primary",disabled:C,children:C?"Uploading...":p?"Update Member":"Add Member"})]})]}),e.length>0&&(0,a.jsxs)("div",{className:"md:col-span-4 border-t border-gray-200 pt-6",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-lg font-semibold text-gray-900",children:"Family Connections (Optional)"}),(0,a.jsx)("p",{className:"text-sm text-gray-600",children:"Define how this member is related to other family members"})]}),(0,a.jsxs)("button",{type:"button",onClick:()=>{v([...j,{relatedMemberId:"",relationshipType:""}])},className:"btn-secondary text-sm",children:[(0,a.jsx)(i.FontAwesomeIcon,{icon:s.faPlus,className:"mr-2"}),"Add Connection"]})]}),j.length>0&&(0,a.jsx)("div",{className:"space-y-3",children:j.map((t,l)=>(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-3 items-end bg-gray-50 p-3 rounded-lg",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"This member is:"}),(0,a.jsxs)("select",{value:t.relationshipType,onChange:e=>L(l,"relationshipType",e.target.value),className:"input-field text-sm",required:!0,children:[(0,a.jsx)("option",{value:"",children:"Select relationship"}),U.map(e=>(0,a.jsx)("option",{value:e,children:e},e))]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Related to:"}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsxs)("select",{value:t.relatedMemberId,onChange:e=>L(l,"relatedMemberId",e.target.value),className:"input-field text-sm flex-1",required:!0,children:[(0,a.jsx)("option",{value:"",children:"Select member"}),e.filter(e=>!p||e.id!==p.id).map(e=>(0,a.jsx)("option",{value:e.id,children:e.name},e.id))]}),(0,a.jsx)("button",{type:"button",onClick:()=>{v(j.filter((e,a)=>a!==l))},className:"text-red-600 hover:text-red-700 px-3 py-2 rounded-lg hover:bg-red-50",children:(0,a.jsx)(i.FontAwesomeIcon,{icon:s.faTrash})})]})]})]},l))}),0===j.length&&(0,a.jsx)("p",{className:"text-sm text-gray-500 text-center py-4",children:'No connections added yet. Click "Add Connection" to define relationships.'})]})]})]}),0===e.length?(0,a.jsxs)("div",{className:"text-center py-12 card",children:[(0,a.jsx)(i.FontAwesomeIcon,{icon:s.faUsers,className:"text-6xl text-gray-300 mb-4"}),(0,a.jsx)("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"No Family Members Yet"}),(0,a.jsx)("p",{className:"text-gray-600 mb-6",children:"Start building your family tree"}),A&&(0,a.jsxs)("button",{onClick:()=>f(!0),className:"btn-primary",children:[(0,a.jsx)(i.FontAwesomeIcon,{icon:s.faPlus,className:"mr-2"}),"Add Your First Member"]})]}):(0,a.jsx)("div",{className:"grid md:grid-cols-2 lg:grid-cols-3 gap-6",children:e.map(t=>(0,a.jsx)("div",{className:"card hover:shadow-lg transition-shadow",children:(0,a.jsxs)("div",{className:"flex items-start justify-between",children:[(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsx)("div",{className:"w-16 h-16 rounded-full overflow-hidden mb-3 border-2 border-indigo-200",children:t.image_url?(0,a.jsx)("img",{src:t.image_url,alt:t.name,className:"w-full h-full object-cover"}):(0,a.jsx)("div",{className:"w-full h-full bg-gradient-to-br from-indigo-400 to-purple-500 flex items-center justify-center",children:(0,a.jsx)(i.FontAwesomeIcon,{icon:s.faUser,className:"text-white text-2xl"})})}),(0,a.jsx)("h3",{className:"text-lg font-semibold text-gray-900",children:t.name}),(0,a.jsx)("p",{className:"text-sm text-gray-600 mt-1",children:t.relationship}),t.email&&(0,a.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:t.email}),Y(t.id).length>0&&(0,a.jsxs)("div",{className:"mt-3 pt-3 border-t border-gray-200",children:[(0,a.jsx)("p",{className:"text-xs font-semibold text-gray-700 mb-1",children:"Connections:"}),(0,a.jsx)("div",{className:"space-y-1",children:Y(t.id).map(t=>{let l;return(0,a.jsxs)("p",{className:"text-xs text-gray-600",children:["â€¢ ",t.relationship_type," ",(0,a.jsx)("span",{className:"font-medium",children:(l=t.related_member_id,e.find(e=>e.id===l)?.name||"Unknown")})]},t.id)})})]})]}),(0,a.jsxs)("div",{className:"flex flex-col gap-2",children:[t.email&&!E[t.id]&&A&&(0,a.jsx)("button",{onClick:()=>G(t),disabled:T===t.id,className:"text-green-600 hover:text-green-700 p-2 rounded-lg hover:bg-green-50 transition-colors disabled:opacity-50",title:"Invite as user",children:(0,a.jsx)(i.FontAwesomeIcon,{icon:s.faPaperPlane})}),A&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("button",{onClick:()=>K(t),className:"text-indigo-600 hover:text-indigo-700 p-2 rounded-lg hover:bg-indigo-50 transition-colors",title:"Edit member",children:(0,a.jsx)(i.FontAwesomeIcon,{icon:s.faEdit})}),(0,a.jsx)("button",{onClick:()=>W(t.id),className:"text-red-600 hover:text-red-700 p-2 rounded-lg hover:bg-red-50 transition-colors",title:"Delete member",children:(0,a.jsx)(i.FontAwesomeIcon,{icon:s.faTrash})})]})]})]})},t.id))})]})}e.s(["default",()=>n,"dynamic",0,"force-dynamic"])}]);